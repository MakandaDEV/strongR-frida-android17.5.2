name: strongR-frida

on:
  schedule:
    - cron: "0 9/12 * * *"
  workflow_dispatch:

jobs: 
  check_version:
    runs-on: ubuntu-22.04
    outputs:
      FRIDA_VERSION: ${{ steps.pullFridaLatestRelease.outputs.FRIDA_VERSION }}
      ALREADY_RELEASE: ${{ steps.checkReleaseVersion.outputs.ALREADY_RELEASE }}
    steps:
      - name: Pull Frida Latest Release
        id: pullFridaLatestRelease
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getLatestRelease({
              owner: 'frida',
              repo: 'frida',
            });
            core.setOutput('FRIDA_VERSION', release.data.tag_name);

      - name: Check release version
        id: checkReleaseVersion
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const releaseVersion = '${{ steps.pullFridaLatestRelease.outputs.FRIDA_VERSION }}';
              await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: releaseVersion
              });
              core.setOutput('ALREADY_RELEASE', '1');
            } catch (e) {
              core.setOutput('ALREADY_RELEASE', '0');
            }

  create_release:
    needs: check_version
    runs-on: ubuntu-22.04
    if: needs.check_version.outputs.ALREADY_RELEASE == '0'
    steps:
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          name: ${{ needs.check_version.outputs.FRIDA_VERSION }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  android_build:
    runs-on: ubuntu-22.04
    needs: [check_version, create_release]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Environment
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup Android NDK
        id: setup-ndk
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25b

      - name: Install Build Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential ninja-build gcc-multilib g++-multilib flex bison ruby python3-pip
          python3 -m pip install lief graphlib

      - name: Build Frida
        shell: bash
        env:
          ANDROID_NDK_ROOT: ${{ steps.setup-ndk.outputs.ndk-path }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Clone patches using the runtime token (Ensure secrets.PATCH_REPO is just the repo name or full URL)
          git clone https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/Patchs.git Patchs
          
          git clone --recurse-submodules https://github.com/frida/frida
          
          cd frida
          # Applying patches
          for path in ../Patchs/strongR-frida/*; do
            [ -d "$path" ] || continue
            name=$(basename "$path")
            echo "Applying patches to subprojects/$name"
            cd "subprojects/$name"
            git am "../../../Patchs/strongR-frida/$name"/*.patch
            cd ../..
          done
          
          ARCHES="android-arm android-arm64 android-x86 android-x86_64"
          for ARCH in $ARCHES; do
            ./configure --host=$ARCH
            make
            # Move binary to a stable path before cleaning or moving to next arch
            mkdir -p ../output/$ARCH
            cp build/frida-server-$ARCH ../output/$ARCH/
          done

      - name: Get Release Info
        id: get_release
        uses: actions/github-script@v7
        with:
          script: |
            const release = await github.rest.repos.getReleaseByTag({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag: '${{ needs.check_version.outputs.FRIDA_VERSION }}'
            });
            core.setOutput('upload_url', release.data.upload_url);

      - name: Package and Upload
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Simplified loop for uploading
          for arch in arm arm64 x86 x86_64; do
            target="frida-server-${{ needs.check_version.outputs.FRIDA_VERSION }}-android-$arch"
            gzip -c output/android-$arch/frida-server > "${target}.gz"
            
            gh release upload ${{ needs.check_version.outputs.FRIDA_VERSION }} "${target}.gz#hluda-server-android-$arch"
          done
